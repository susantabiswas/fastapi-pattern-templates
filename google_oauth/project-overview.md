# FastAPI Google OAuth2 Project Overview

## Setup Instructions
- Create a virtual environment
    ```
    python -m venv env
    ```

- Activate the virtual environment

    On Windows:
    ```
    env\Scripts\activate
    ```

    On Linux or macOS:
    ```
    source env/bin/activate
    ```


1. Install the required dependencies:
   ```
   python -m pip install fastapi uvicorn sqlalchemy python-dotenv validators PyJWT Authlib pydantic_settings httpx
   ```
    In case of any missing dependencies, install them using pip.
    ```bash
    pip install -r requirements.txt
    ```

2. Google OAuth2 Setup
    - Visit [Google Developer Console](https://console.cloud.google.com/apis/credentials)
    - click "Create Credentials" and select "OAuth client ID"
    - [Optional] Might have to configure "OAuth consent screen" first
    - select "Web Application" and click "Create"
    - copy the "Client ID" and "Client Secret" and paste them in the `.env` file

3. Use the sample `sample.env` file in the project root and fill the values, make sure to rename the file to `.env`:
   ```
   GOOGLE_CLIENT_ID=your_google_client_id
   GOOGLE_CLIENT_SECRET=your_google_client_secret
   JWT_SECRET_KEY=your_generated_jwt_secret_key
   SESSION_SECRET_KEY=another_generated_secret_key
   ```
    - To generate secret keys, run:
    ```
    python -c "import secrets; print(secrets.token_hex(32))"
    ```

4. Run the FastAPI application:
   ```
   uvicorn google_oauth.main:app --reload
   ```
   or
   ```
   python -m google_oauth.main
   ```

## Project Overview

This project implements a FastAPI application with Google OAuth2 authentication and JWT token-based authorization. It provides a secure way to authenticate users using their Google accounts and manage user sessions using JWT tokens.

Key components:
- FastAPI for the web framework
- SQLAlchemy for database operations
- Authlib for OAuth2 integration
- PyJWT for JWT token handling
- Pydantic for data validation and settings management

## API Flows

1. Google OAuth2 Login Flow:
   - User initiates login: `GET /auth/login`
   - User is redirected to Google for authentication
   - Google redirects back to: `GET /auth/callback/google`
   - Application verifies the user and issues JWT tokens

2. JWT Authentication Flow:
   - User sends JWT token in the Authorization header
   - Application verifies the token and allows/denies access

3. Token Refresh Flow:
   - User sends refresh token: `POST /auth/refresh`
   - Application verifies the refresh token and issues new access and refresh tokens

4. Get Current User:
   - Authenticated user requests their info: `GET /auth/me`
   - Application returns the user's details

## Supporting Concepts

### How `state` is used in Google OAuth2

- Google OAuth2 uses the `state` parameter to prevent CSRF attacks. It is a random string generated by the application and sent to Google. Google then returns the same `state` parameter in the response. The application can then verify that the `state` parameter matches the one it generated.

- The `state` is stored in the session and sent to Google.

### OAuth2
OAuth2 is an authorization framework that enables applications to obtain limited access to user accounts on an HTTP service. In this project, we use it to allow users to sign in with their Google accounts.

### Environment Variables
Sensitive information and configuration settings are stored in environment variables, loaded from a `.env` file using `pydantic_settings`.

### CORS (Cross-Origin Resource Sharing)
CORS middleware is implemented to control which domains can access the API, enhancing security.

### Dependency Injection
FastAPI's dependency injection system is used for database sessions and authentication, promoting clean and testable code.

This project serves as a template for implementing secure authentication in FastAPI applications, demonstrating best practices for OAuth2, JWT handling, and user management.